console.log("\uD83D\uDE80 [PRIJIT SPORT] Script starting...",new Date().toISOString());const DEBUG_MODE=!1;function debugLog(...e){}console.log("\uD83D\uDC1B Debug mode:","OFF");const CONFIG={DEBUG_MODE:!1,FIREBASE_RETRY_MAX:50,FIREBASE_RETRY_INTERVAL:100,AVAILABILITY_CHECK_TIMEOUT:1e4,TOAST_DURATION:3e3,DEBOUNCE_DELAY:150,SLIDER_INTERVAL:4e3};!function(){debugLog("\uD83E\uDDF9 [1/3] Cache cleanup...");try{localStorage.clear(),debugLog("  ‚úÖ localStorage cleared")}catch(e){}try{sessionStorage.clear(),debugLog("  ‚úÖ sessionStorage cleared")}catch(t){}debugLog("‚úÖ [1/3] Cache cleanup complete")}(),debugLog("\uD83D\uDCE6 [2/3] Declaring global variables...");let auth,database,currentUser=null,isCancelling=!1;function initNavigation(){console.log("\uD83E\uDDED Initializing navigation...");let e=document.querySelectorAll("#desktopNav .nav-item");e.forEach(e=>{e.addEventListener("click",function(){let e=this.getAttribute("data-section");scrollToSection(e)})});let t=document.querySelectorAll("#mobileNav .nav-item");t.forEach(e=>{e.addEventListener("click",function(){let e=this.getAttribute("data-section");scrollToSection(e),closeMobileMenu()})});let n=document.getElementById("hamburgerBtn");n&&n.addEventListener("click",toggleMobileMenu);let i=document.getElementById("logoutBtn");i&&i.addEventListener("click",handleLogout);let o=document.getElementById("loginNavBtn");o&&o.addEventListener("click",openLoginModal),console.log("‚úÖ Navigation initialized")}function scrollToSection(e){let t=document.getElementById(e);t&&t.scrollIntoView({behavior:"smooth",block:"start"})}function debounce(e,t){let n;return function(...i){clearTimeout(n),n=setTimeout(()=>e.apply(this,i),t)}}function togglePassword(e,t){let n=document.getElementById(e);n&&("password"===n.type?(n.type="text",t.textContent="\uD83D\uDE48"):(n.type="password",t.textContent="\uD83D\uDC41Ô∏è"))}function openLoginModal(){let e=document.getElementById("loginModal");e&&(e.classList.add("active"),showLoginInModal())}function closeLoginModal(){let e=document.getElementById("loginModal");e&&e.classList.remove("active")}function showLoginInModal(){document.getElementById("modalLoginForm").style.display="block",document.getElementById("modalRegisterForm").style.display="none"}function showRegisterInModal(){document.getElementById("modalLoginForm").style.display="none",document.getElementById("modalRegisterForm").style.display="block"};
const regTitle = document.querySelector("#modalRegisterForm .auth-title");
    if(regTitle) {
        regTitle.scrollIntoView({ behavior: "smooth", block: "start" });
    }
function toggleMobileMenu(){let e=document.getElementById("menuOverlay"),t=document.getElementById("hamburgerBtn");if(!e||!t)return;let n=e.classList.contains("active");n?closeMobileMenu():(e.classList.add("active"),t.classList.add("active"),document.body.style.overflow="hidden")}function closeMobileMenu(){let e=document.getElementById("menuOverlay"),t=document.getElementById("hamburgerBtn");e&&e.classList.remove("active"),t&&t.classList.remove("active"),document.body.style.overflow=""}let selectedTimeSlot=null,currentBookingData=null,uploadedSlipFile=null,currentAvailabilityCheck=null,lastMenuToggleTime=0;const MENU_TOGGLE_DELAY=300;let lastNavigationTime=0;const NAVIGATION_DELAY=300;let currentSlideIndex=0,slideInterval=null;const galleryImages=["f11.jpg","f8.jpg","f9.jpg","f1.jpg","f10.jpg","f2.jpg","f3.jpg"];let currentGalleryIndex=0,paymentTimer=null;const DEPOSIT_PERCENTAGE=.3,MAX_BOOKING_DAYS=30,MAX_FILE_SIZE_MB=5,PAYMENT_TIMEOUT_MINUTES=15,MAX_FILE_SIZE_BYTES=5242880;debugLog("‚úÖ [2/3] Global variables initialized"),debugLog("  ‚öôÔ∏è NAVIGATION_DELAY:",300,"ms"),debugLog("  ‚öôÔ∏è MENU_TOGGLE_DELAY:",300,"ms");const SecurityUtils={escapeHtml(e){if("string"!=typeof e)return"";let t=document.createElement("div");return t.textContent=e,t.innerHTML},sanitizeInput(e,t={}){if("string"!=typeof e)return"";let n={maxLength:500,allowSpaces:!0,allowNumbers:!0,allowThai:!0,allowEnglish:!0,allowSpecialChars:!1,...t},i=e.trim();i=(i=i.replace(/[<>\"'`]/g,"")).substring(0,n.maxLength);let o="";if(n.allowThai&&(o+="‡∏Å-‡πô"),n.allowEnglish&&(o+="a-zA-Z"),n.allowNumbers&&(o+="0-9"),n.allowSpaces&&(o+="\\s"),n.allowSpecialChars&&(o+="._-"),o){let a=RegExp(`[^${o}]`,"g");i=i.replace(a,"")}return i},sanitizePhone:e=>"string"!=typeof e?"":e.replace(/[^0-9]/g,"").substring(0,10),sanitizeUsername:e=>"string"!=typeof e?"":e.trim().toLowerCase().replace(/[^a-z0-9_]/g,"").substring(0,50)},Validator={username:e=>!e||e.trim().length<3?"‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 3 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£":e.trim().length>50?"‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 50 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)":/^[a-zA-Z0-9_]+$/.test(e.trim())?/^[0-9]/.test(e.trim())?"‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£":null:"‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ A-Z, ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 0-9 ‡πÅ‡∏•‡∏∞ _ ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô",fullname:e=>!e||e.trim().length<2?"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)":e.trim().length>100?"‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 100 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)":/[‡∏Å-‡πôa-zA-Z]{2,}/.test(e)?null:"‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏ï‡∏±‡∏ß",name(e){return this.fullname(e)},phone(e){if(!e)return"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå";let t=e.replace(/[\s-]/g,"");if(!/^0[0-9]{9}$/.test(t))return"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ 0 ‡πÅ‡∏•‡∏∞‡∏°‡∏µ 10 ‡∏´‡∏•‡∏±‡∏Å)";let n=t.substring(0,2);return["08","09","06","02","03","04","05","07"].includes(n)?null:"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (prefix ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á)"},email:e=>e?/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e)?null:"‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á":"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•",password:e=>e?e.length<6?"‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£":e.length>128?"‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 128 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)":null:"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",field:e=>e?null:"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏ô‡∏≤‡∏°",date(e){if(!e)return"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà";let t=new Date(e),n=new Date;if(n.setHours(0,0,0,0),t<n)return"‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï‡πÑ‡∏î‡πâ";let i=new Date;return(i.setDate(i.getDate()+30),t>i)?"‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ß‡∏±‡∏ô":null},time:e=>e?null:"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤",file:(e,t=5)=>e?["image/jpeg","image/jpg","image/png"].includes(e.type)?e.size>1048576*t?`‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ (‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô ${t} MB)`:null:"‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÑ‡∏ü‡∏•‡πå JPG ‡πÅ‡∏•‡∏∞ PNG ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô":"‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå",form(e){let t={};return Object.keys(e).forEach(n=>{if(this[n]){let i=this[n](e[n]);i&&(t[n]=i)}}),Object.keys(t).length>0?t:null}};function validateAllFields(e){let t={};return Object.keys(e).forEach(n=>{let i=Validator[n];if(i&&"function"==typeof i){let o=i(e[n]);o&&(t[n]=o)}}),Object.keys(t).length>0?t:null}function showValidationErrors(e,t=null){if(!e)return;let n=Object.entries(e).map(([e,t])=>{let n=getFieldDisplayName(e);return`‚Ä¢ ${n}: ${t}`}).join("\n");showToast("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:\n"+n,"error",5e3),Object.keys(e).forEach(n=>{let i=document.getElementById(n)||document.querySelector(`[name="${n}"]`)||document.querySelector(`#${t} [name="${n}"]`);i&&(i.classList.add("error"),i.addEventListener("focus",function(){this.classList.remove("error")},{once:!0}),Object.keys(e)[0]===n&&(i.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>i.focus(),500)))})}function getFieldDisplayName(e){return({username:"‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ",fullname:"‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•",phone:"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£",password:"‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô",field:"‡∏™‡∏ô‡∏≤‡∏°",date:"‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà",time:"‡πÄ‡∏ß‡∏•‡∏≤"})[e]||e}function startSlider(){slideInterval=setInterval(()=>changeSlide(1),4e3)}function stopSlider(){clearInterval(slideInterval)}function showSlide(e){let t=document.querySelectorAll(".slide"),n=document.querySelectorAll(".dot");e>=t.length&&(currentSlideIndex=0),e<0&&(currentSlideIndex=t.length-1),t.forEach(e=>e.classList.remove("active")),n.forEach(e=>e.classList.remove("active")),t[currentSlideIndex].classList.add("active"),n[currentSlideIndex].classList.add("active")}function changeSlide(e){currentSlideIndex+=e;let t=document.querySelectorAll(".slide");currentSlideIndex>=t.length?currentSlideIndex=0:currentSlideIndex<0&&(currentSlideIndex=t.length-1),showSlide(currentSlideIndex),stopSlider(),startSlider()}function currentSlide(e){showSlide(currentSlideIndex=e),stopSlider(),startSlider()}function changeGalleryImage(e){(currentGalleryIndex+=e)<0?currentGalleryIndex=galleryImages.length-1:currentGalleryIndex>=galleryImages.length&&(currentGalleryIndex=0),updateGalleryDisplay()}function selectGalleryImage(e){currentGalleryIndex=e,updateGalleryDisplay()}function updateGalleryDisplay(){document.getElementById("galleryMainImage").src=galleryImages[currentGalleryIndex],document.getElementById("currentImageNumber").textContent=currentGalleryIndex+1,document.getElementById("totalImages").textContent=galleryImages.length;let e=document.querySelectorAll(".gallery-thumbnail");e.forEach((e,t)=>{t===currentGalleryIndex?e.classList.add("active"):e.classList.remove("active")})}function isInViewport(e){let t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=(window.innerHeight||document.documentElement.clientHeight)&&t.right<=(window.innerWidth||document.documentElement.clientWidth)}function openStaffModal(e){let t=document.getElementById("staffGalleryModal"),n=document.getElementById("staffGalleryModalImg");if(!t||!n){console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Modal elements");return}let i=new Image;i.onload=function(){n.src=e},i.onerror=function(){console.warn("‚ö†Ô∏è ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß, ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"),n.src=e},i.src=e,t.classList.add("show"),document.body.style.overflow="hidden"}function closeStaffModal(){let e=document.getElementById("staffGalleryModal");e?(e.classList.remove("show"),document.body.style.overflow="",console.log("‚úÖ Modal ‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡πâ‡∏ß")):console.error("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö Modal")}function initializeTimeSlots(){let e=document.querySelectorAll(".time-slot-btn");e.forEach(e=>{let t=!1;e.addEventListener("touchend",function(e){if(e.preventDefault(),e.stopPropagation(),this.classList.contains("booked")){alert("‚ùå ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô");return}t=!0,selectTime(this),setTimeout(()=>{t=!1},300)},{passive:!1}),e.addEventListener("click",function(e){if(t){e.preventDefault();return}if(this.classList.contains("booked")){alert("‚ùå ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô");return}selectTime(this)})})}function selectTime(e){if(e.classList.contains("booked"))return;let t=document.querySelectorAll(".time-slot-btn");t.forEach(e=>e.classList.remove("selected")),e.classList.add("selected"),selectedTimeSlot=e.getAttribute("data-time")}function resetTimeSlots(){let e=document.querySelectorAll(".time-slot-btn");e.forEach(e=>{e.classList.remove("available","booked","selected"),e.disabled=!1;let t=e.querySelector(".status-badge");t&&t.remove()})}function checkAvailability(){currentAvailabilityCheck&&"function"==typeof currentAvailabilityCheck.off&&currentAvailabilityCheck.off(),currentAvailabilityCheck=null;let e=document.getElementById("fieldSelect").value,t=document.getElementById("dateSelect").value;if(!e||!t){resetTimeSlots();return}let n=document.getElementById("availabilityStatus");n.style.display="block",n.className="availability-notice checking",n.innerHTML="<strong>‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏ô‡∏≤‡∏°...</strong>";let i=setTimeout(()=>{n.innerHTML='<strong style="color: #ef4444;">‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏•‡πà‡∏≤‡∏ä‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</strong>'},1e4),o=database.ref("bookings").orderByChild("field").equalTo(e);currentAvailabilityCheck=o,o.once("value").then(e=>{if(clearTimeout(i),currentAvailabilityCheck!==o){console.log("‚ö†Ô∏è Request ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß");return}let a=[];e.forEach(e=>{let n=e.val();n.date===t&&"cancelled"!==n.bookingStatus&&a.push(n.time)}),updateTimeSlotAvailability(a),n.style.display="none",currentAvailabilityCheck=null}).catch(e=>{clearTimeout(i),currentAvailabilityCheck===o&&(console.error("Error checking availability:",e),n.className="availability-notice",n.style.display="block",n.innerHTML='<strong style="color: #ef4444;">‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á</strong>',currentAvailabilityCheck=null)})}function updateTimeSlotAvailability(e){let t=document.querySelectorAll(".time-slot-btn"),n=new Set(e),i=document.getElementById("dateSelect").value;if(!i){resetTimeSlots();return}let o=new Date;o.setHours(0,0,0,0);let a=new Date(i+"T00:00:00"),l=a<o,r=a.getTime()===o.getTime(),s=a>o,d=new Date,c=d.getHours(),u=d.getMinutes();t.forEach(e=>{let t=e.getAttribute("data-time");e.classList.remove("available","booked","selected","past-time");let i=e.querySelector(".status-badge");i&&i.remove(),e.style.opacity="1";let o=!1,a="‡∏ß‡πà‡∏≤‡∏á",d="",g="available";if(l)o=!0,a="‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß",d="#ef4444",g="booked past-time",e.style.opacity="0.5";else if(r){let p=t.split(" - ")[0],[m,f]=p.split(":").map(Number);m<c||m===c&&f<=u?(o=!0,a="‡∏ú‡πà‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß",d="#ef4444",g="booked past-time",e.style.opacity="0.5"):n.has(t)?(o=!0,a="‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á",d="",g="booked"):(o=!1,a="‡∏ß‡πà‡∏≤‡∏á",d="",g="available")}else s&&(n.has(t)?(o=!0,a="‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏á",d="",g="booked"):(o=!1,a="‡∏ß‡πà‡∏≤‡∏á",d="",g="available"));e.classList.add(...g.split(" ")),e.disabled=o;let y=document.createElement("span");y.className="status-badge",y.textContent=a,d&&(y.style.background=d),e.appendChild(y)})}function resetBookingForm(){document.getElementById("fieldSelect").value="",document.getElementById("dateSelect").value="",selectedTimeSlot=null,resetTimeSlots()}async function handleLogin(e){e.preventDefault();let t=e.target.querySelector('button[type="submit"]'),n=t.textContent;try{let i=document.getElementById("modalLoginUsername"),o=document.getElementById("modalLoginPassword"),a=i.value,l=o.value,r={},s=Validator.username(a);s&&(r.modalLoginUsername=s);let d=Validator.password(l);if(d&&(r.modalLoginPassword=d),Object.keys(r).length>0){showValidationErrors(r);return}let c=SecurityUtils.sanitizeUsername(a);if(!c||c.length<3){showToast("‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á","error"),i.focus();return}t.disabled=!0,t.innerHTML="‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";let u=await auth.signInWithEmailAndPassword(c+"@prijitsport.com",l),g=await database.ref("users/"+u.user.uid).once("value"),p=g.val();currentUser={uid:auth.currentUser.uid,username:SecurityUtils.escapeHtml(p.username||""),fullname:SecurityUtils.escapeHtml(p.fullname||""),phone:SecurityUtils.sanitizePhone(p.phone||""),createdAt:p.createdAt},document.getElementById("currentUser").textContent=currentUser.fullname,document.getElementById("loginNavBtn").style.display="none",document.getElementById("userInfo").style.display="flex",closeLoginModal(),showToast("‚úÖ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö "+currentUser.fullname,"success"),e.target.reset(),updateBookingList()}catch(m){console.error("Login error:",m);let f="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";"auth/user-not-found"===m.code?f="‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö":"auth/wrong-password"===m.code?f="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á":"auth/too-many-requests"===m.code?f="‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡πà‡∏≠‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà":"auth/network-request-failed"===m.code&&(f="‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠"),showToast("‚ùå "+f,"error")}finally{t.disabled=!1,t.textContent=n}}async function handleRegister(e){e.preventDefault();let t=e.target.querySelector('button[type="submit"]'),n=t.textContent;try{let i=document.getElementById("modalRegUsername"),o=document.getElementById("modalRegFullname"),a=document.getElementById("modalRegPhone"),l=document.getElementById("modalRegPassword"),r=i.value,s=o.value,d=a.value,c=l.value,u=validateAllFields({username:r,fullname:s,phone:d,password:c});if(u){showValidationErrors(u);return}let g={username:SecurityUtils.sanitizeUsername(r),fullname:SecurityUtils.sanitizeInput(s,{allowThai:!0,allowEnglish:!0,allowSpaces:!0,maxLength:100}),phone:SecurityUtils.sanitizePhone(d)};if(!g.username||g.username.length<3){showToast("‚ùå ‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á","error"),i.focus();return}if(!g.fullname||g.fullname.length<2){showToast("‚ùå ‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á","error"),o.focus();return}if(!g.phone||10!==g.phone.length){showToast("‚ùå ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á","error"),a.focus();return}t.disabled=!0,t.innerHTML="‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...";let p=g.username+"@prijitsport.com",m=await auth.createUserWithEmailAndPassword(p,c);await database.ref("users/"+m.user.uid).set({username:g.username,fullname:g.fullname,phone:g.phone,createdAt:new Date().toISOString()}),showToast("‚úÖ ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö","success",4e3),e.target.reset(),setTimeout(()=>{showLoginInModal()},500)}catch(f){console.error("Register error:",f);let y="‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á";"auth/email-already-in-use"===f.code?y="‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô":"auth/weak-password"===f.code?y="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏Ç‡πá‡∏á‡πÅ‡∏£‡∏á‡∏Ç‡∏∂‡πâ‡∏ô":"auth/network-request-failed"===f.code?y="‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠":"auth/operation-not-allowed"===f.code&&(y="‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß"),showToast("‚ùå "+y,"error",5e3)}finally{t.disabled=!1,t.textContent=n}}async function handleLogout(){let e=confirm("‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?");if(e)try{showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö..."),await auth.signOut(),currentUser=null,document.getElementById("loginNavBtn").style.display="inline-block",document.getElementById("userInfo").style.display="none";let t=document.getElementById("bookingList");t&&(t.innerHTML=`
        <div style="text-align: center; padding: 40px;">
          <p style="color: #6b7280; font-size: 1.1em; margin-bottom: 20px;">
            ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
          </p>
          <button onclick="openLoginModal()" 
                  style="background: #22c55e; color: white; padding: 12px 24px; 
                         border: none; border-radius: 8px; font-weight: 600; 
                         cursor: pointer; font-size: 1em;">
            üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
          </button>
        </div>
      `),hideLoading(),showToast("‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢","success"),window.scrollTo({top:0,behavior:"smooth"})}catch(n){console.error("Logout error:",n),hideLoading(),showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö","error")}}function confirmBooking(){if(!currentUser){showToast("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°","warning",4e3),setTimeout(()=>openLoginModal(),500);return}let e=document.getElementById("fieldSelect").value,t=document.getElementById("dateSelect").value;if(!e||!t||!selectedTimeSlot){showToast("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô","error");return}let n=new Date(t),i=new Date;if(i.setHours(0,0,0,0),n.getTime()===i.getTime()){let o=new Date,a=o.getHours(),l=o.getMinutes(),r=selectedTimeSlot.split(" - ")[0],[s,d]=r.split(":").map(Number);if(s<a||s===a&&d<=l){showToast("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô","error");return}}if(n<i){alert("‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ");return}let c=new Date(i);if(c.setDate(c.getDate()+30),n>c){alert("‚ùå ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 30 ‡∏ß‡∏±‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô");return}let u=0,g=parseInt(selectedTimeSlot.split(":")[0]);e.includes("‡∏™‡∏ô‡∏≤‡∏° 1")||e.includes("‡∏™‡∏ô‡∏≤‡∏° 2")||e.includes("‡∏™‡∏ô‡∏≤‡∏° 3")?u=g>=18?1200:1e3:e.includes("‡∏™‡∏ô‡∏≤‡∏° 4")?u=g>=18?1300:1100:e.includes("‡∏™‡∏ô‡∏≤‡∏° 5")?u=g>=18?1100:900:e.includes("‡∏™‡∏ô‡∏≤‡∏° 6")&&(u=g>=18?900:700);let p=Math.round(.3*u),m=u-p;currentBookingData={field:e,date:t,time:selectedTimeSlot,totalPrice:u,depositAmount:p,remainingAmount:m};let f=`üìã ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:

üìç ‡∏™‡∏ô‡∏≤‡∏°: ${e}
üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${t}
‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${selectedTimeSlot}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üí∞ ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${u.toLocaleString()} ‡∏ö‡∏≤‡∏ó
üíµ ‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥ 30%: ${p.toLocaleString()} ‡∏ö‡∏≤‡∏ó
üí∏ ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${m.toLocaleString()} ‡∏ö‡∏≤‡∏ó
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

üë§ ‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á: ${currentUser.fullname}
üìû ‡πÄ‡∏ö‡∏≠‡∏£‡πå: ${currentUser.phone}

‚ö†Ô∏è ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç:
- ‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥ ${p.toLocaleString()} ‡∏ö‡∏≤‡∏ó‡∏ú‡πà‡∏≤‡∏ô QR Code
- ‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î = ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
- ‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î = ‡∏£‡∏¥‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥

‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ï‡πà‡∏≠?`;confirm(f)&&showPaymentModal()}function showPaymentModal(){let e=currentBookingData,t=`
    <div id="paymentModal" class="payment-modal active">
      <div class="payment-content">
        <div class="payment-header">
          <h2>üí≥ ‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥</h2>
          <p>‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏° ${e.field}</p>
        </div>

        <div class="payment-summary">
          <div class="summary-row">
            <span class="summary-label">üíµ ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î:</span>
            <span class="summary-value">${e.totalPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">üìç ‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥ 30%:</span>
            <span class="summary-value">${e.depositAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">üí∏ ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠:</span>
            <span class="summary-value">${e.remainingAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
          </div>
          <div class="summary-row">
            <span class="summary-label">üí∞ ‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ:</span>
            <span class="summary-value" style="color: #22c55e; font-size: 1.3em;">${e.depositAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</span>
          </div>
        </div>

        <div class="deposit-highlight">
          <p><strong>üì± ‡∏™‡πÅ‡∏Å‡∏ô QR Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡∏Ñ‡πà‡∏≤‡∏°‡∏±‡∏î‡∏à‡∏≥</strong></p>
          <p style="font-size: 0.95em; color: #16a34a; margin-top: 5px;">
            ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏û‡∏µ‡∏¢‡∏á ${e.depositAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏ô‡∏≤‡∏°
          </p>
        </div>

        <div class="qr-code-container">

          <div class="qr-code-image" style="position: relative; min-height: 300px;">
            <!-- Loading State -->
            <div id="qrLoading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #6b7280;">
              <div style="width: 40px; height: 40px; border: 3px solid #f3f4f6; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 10px;"></div>
              <p style="font-size: 0.9em;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î QR Code...</p>
            </div>
            <!-- QR Code Image -->
            <img id="qrCodeCanvas" src="qr-promptpay.png" alt="QR Code PromptPay" 
                style="width: 100%; height: 100%; object-fit: contain; display: none;"
                onload="this.style.display='block'; var loader = document.getElementById('qrLoading'); if (loader) loader.remove();"
                onerror="handleQRError(this)">
          </div>




        </div>
        
        <div class="payment-info">
          <p><strong>üí∞ ‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞:</strong> ${e.depositAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
          <p><strong>üì± ‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå:</strong> 1103100835163</p>
          <p><strong>üè¢ ‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ:</strong> ‡∏ô‡∏≤‡∏¢ ‡∏û‡∏±‡∏™‡∏Å‡∏£ ‡∏£‡∏≤‡∏ä‡∏ä‡∏°‡∏†‡∏π</p>
          <p><strong>üÜî Ref:</strong> ${e.field.replace("‡∏™‡∏ô‡∏≤‡∏° ","F")}-${e.date.replace(/-/g,"")}</p>
        </div>

        <div class="upload-section">
          <label class="upload-label">üì§ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
          <div class="upload-area" id="uploadArea" onclick="document.getElementById('slipInput').click()">
            <p>üìé ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ</p>
            <p style="font-size: 0.9em; color: #6b7280; margin-top: 10px;">
              ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà<br>
              ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: JPG, PNG (‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)
            </p>
          </div>
          <input type="file" id="slipInput" accept="image/*" style="display: none;" onchange="handleSlipUpload(event)">
          <img id="slipPreview" style="display: none;">
        </div>

        <div class="payment-terms">
          <h4>‚ö†Ô∏è ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥</h4>
          <ul>
            <li>‚úÖ ‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î: ‡∏Ñ‡∏∑‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥ ${e.depositAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</li>
            <li>‚ùå ‡πÑ‡∏°‡πà‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡∏ô‡∏±‡∏î: ‡∏£‡∏¥‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</li>
            <li>üìå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ 15 ‡∏ô‡∏≤‡∏ó‡∏µ</li>
          </ul>
        </div>

        <div class="payment-buttons">
          <button class="cancel-payment-btn" onclick="closePaymentModal()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
          <button class="upload-slip-btn" id="confirmPaymentBtn" disabled onclick="submitPayment()">
            ‚¨ÜÔ∏è ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ
          </button>
        </div>

        <div class="timer-warning" id="paymentTimer">
          ‚è∞ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 15 ‡∏ô‡∏≤‡∏ó‡∏µ
        </div>
      </div>
    </div>
  `;document.body.insertAdjacentHTML("beforeend",t),generateQRCode(e),startPaymentTimer(),setupDragDrop()}function generateQRCode(e){console.log("‚úÖ QR Code loaded for deposit:",e.depositAmount,"‡∏ö‡∏≤‡∏ó")}function handleQRError(e){e.style.display="none";let t=e.parentElement;t.innerHTML=`
    <div style="padding: 20px; text-align: center; color: #ef4444;">
      <p style="font-size: 1.2em; margin-bottom: 10px;">‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö QR Code</p>
      <p style="font-size: 0.9em; color: #6b7280;">
        ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏õ‡∏ó‡∏µ‡πà:<br>
        <strong style="color: #1f2937;">‡πÄ‡∏•‡∏Ç‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏û‡∏¢‡πå: 1103100835163</strong><br>
        <strong style="color: #1f2937;">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ: ‡∏ô‡∏≤‡∏¢ ‡∏û‡∏±‡∏™‡∏Å‡∏£ ‡∏£‡∏≤‡∏ä‡∏ä‡∏°‡∏†‡∏π</strong>
      </p>
    </div>
  `,console.warn("‚ö†Ô∏è QR Code image not available, showing PromptPay details instead")}function handleSlipUpload(e){let t=e.target.files[0];if(!t)return;if(!["image/jpeg","image/jpg","image/png"].includes(t.type)){alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏†‡∏≤‡∏û‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (JPG, PNG)"),e.target.value="";return}if(t.size>5242880){alert("‚ùå ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏ç‡πà‡πÄ‡∏Å‡∏¥‡∏ô‡πÑ‡∏õ! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 5 MB\n‡∏Ç‡∏ô‡∏≤‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì: "+(t.size/1024/1024).toFixed(2)+" MB"),e.target.value="";return}uploadedSlipFile=t;let n=new FileReader;n.onload=function(e){let t=document.getElementById("slipPreview");t.src=e.target.result,t.style.display="block",document.getElementById("confirmPaymentBtn").disabled=!1},n.readAsDataURL(t)}function setupDragDrop(){let e=document.getElementById("uploadArea"),t=t=>{t.preventDefault(),e.classList.add("dragover")},n=()=>{e.classList.remove("dragover")},i=t=>{t.preventDefault(),e.classList.remove("dragover");let n=t.dataTransfer.files[0];if(n&&n.type.startsWith("image/")){let i=document.getElementById("slipInput"),o=new DataTransfer;o.items.add(n),i.files=o.files,handleSlipUpload({target:i})}};e.addEventListener("dragover",t,{passive:!1}),e.addEventListener("dragleave",n,{passive:!0}),e.addEventListener("drop",i,{passive:!1}),e._dragHandlers={handleDragOver:t,handleDragLeave:n,handleDrop:i}}function startPaymentTimer(){let e=900,t=document.getElementById("paymentTimer");paymentTimer=setInterval(()=>{e--;let n=Math.floor(e/60),i=e%60;t.textContent=`‚è∞ ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ ${n}:${i.toString().padStart(2,"0")} ‡∏ô‡∏≤‡∏ó‡∏µ`,e<=0&&(clearInterval(paymentTimer),alert("‚ùå ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á"),closePaymentModal())},1e3)}function closePaymentModal(){clearInterval(paymentTimer),cleanupBookingLock();let e=document.getElementById("uploadArea");e&&e._dragHandlers&&(e.removeEventListener("dragover",e._dragHandlers.handleDragOver),e.removeEventListener("dragleave",e._dragHandlers.handleDragLeave),e.removeEventListener("drop",e._dragHandlers.handleDrop),delete e._dragHandlers);let t=document.getElementById("paymentModal");t&&t.remove(),currentBookingData=null,uploadedSlipFile=null}function cleanupBookingLock(){if(currentBookingData){let e=`${currentBookingData.field}_${currentBookingData.date}_${currentBookingData.time}`;database.ref("booking_locks/"+e).remove()}}function submitPayment(){if(!uploadedSlipFile){alert("‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô");return}let e=document.getElementById("confirmPaymentBtn");e.disabled=!0,e.innerHTML='‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î... <span class="spinner"></span>',uploadSlipAndCreateBooking()}function uploadSlipAndCreateBooking(){let e=currentBookingData,t=new FileReader;t.onload=function(t){let n=t.target.result,i=database.ref("bookings").push(),o=`${e.field}_${e.date}_${e.time}`,a={userId:currentUser.uid,username:currentUser.fullname,phone:currentUser.phone,field:e.field,date:e.date,time:e.time,totalPrice:e.totalPrice,depositAmount:e.depositAmount,remainingAmount:e.remainingAmount,depositStatus:"pending",depositSlipUrl:n,depositPaidAt:new Date().toISOString(),remainingStatus:"unpaid",remainingPaidAt:null,bookingStatus:"pending_payment",checkedInAt:null,completedAt:null,depositRefunded:!1,depositRefundedAt:null,depositForfeited:!1,depositForfeitedAt:null,field_date_time:o,createdAt:new Date().toISOString()};database.ref("booking_locks/"+o).transaction(e=>null===e?{locked:!0,timestamp:Date.now()}:void 0,(t,n,l)=>{t?(alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+t.message),document.getElementById("confirmPaymentBtn").disabled=!1,document.getElementById("confirmPaymentBtn").textContent="‚¨ÜÔ∏è ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ"):n?i.set(a).then(()=>{clearInterval(paymentTimer),alert(`‚úÖ ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!

üìã ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á: #${i.key.substr(-6).toUpperCase()}

‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 5 ‡∏ô‡∏≤‡∏ó‡∏µ
‡∏Ñ‡∏∏‡∏ì‡∏à‡∏∞‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ú‡πà‡∏≤‡∏ô SMS

üìç ‡∏™‡∏ô‡∏≤‡∏°: ${e.field}
üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${e.date}
‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤: ${e.time}
üí∞ ‡∏°‡∏±‡∏î‡∏à‡∏≥: ${e.depositAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó ‚úÖ
üí∏ ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠: ${e.remainingAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó

‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏°‡∏≤‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏±‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô‡∏°‡∏±‡∏î‡∏à‡∏≥‡∏Ñ‡∏∑‡∏ô`),closePaymentModal(),resetBookingForm(),document.location.href="#checkBookingSection",updateBookingList()}).catch(e=>{database.ref("booking_locks/"+o).remove(),alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+e.message),document.getElementById("confirmPaymentBtn").disabled=!1,document.getElementById("confirmPaymentBtn").textContent="‚¨ÜÔ∏è ‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ"}):(alert("‚ùå ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô"),closePaymentModal(),checkAvailability())})},t.readAsDataURL(uploadedSlipFile)}function updateBookingList(){console.log("\uD83D\uDD04 [UpdateList] Updating booking list...");let e=document.getElementById("bookingList");if(!e){console.log("‚ùå [UpdateList] bookingList element not found");return}let t=auth.currentUser;if(!t){console.log("‚è≠Ô∏è [UpdateList] No user logged in"),e.innerHTML=`
      <div style="text-align: center; padding: 40px;">
        <p style="color: #6b7280; font-size: 1.1em; margin-bottom: 20px;">
          ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
        </p>
        <button onclick="openLoginModal()" 
                style="background: #22c55e; color: white; padding: 12px 24px; 
                       border: none; border-radius: 8px; font-weight: 600; 
                       cursor: pointer; font-size: 1em;">
          üîê ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
        </button>
      </div>
    `;return}console.log(`üë§ [UpdateList] Fetching bookings for user: ${t.uid}`),e.innerHTML='<p style="text-align: center; color: #666;">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>',database.ref("bookings").orderByChild("userId").equalTo(t.uid).once("value").then(t=>{if(console.log(`üìä [UpdateList] Snapshot exists: ${t.exists()}`),!t.exists()){e.innerHTML=`
          <div style="text-align: center; padding: 40px;">
            <p style="color: #6b7280; font-size: 1.1em;">
              ‚öΩ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
            </p>
            <p style="color: #9ca3af; margin-top: 10px;">
              ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≠‡∏á‡∏™‡∏ô‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢!
            </p>
          </div>
        `;return}let n=[];if(t.forEach(e=>{let t=e.val();t.id=e.key,"rejected"!==t.bookingStatus&&(n.push(t),console.log(`  üìã Booking ${t.id}: ${t.field} | ${t.date} | Status: ${t.bookingStatus}`))}),console.log(`‚úÖ [UpdateList] Total bookings: ${n.length}`),0===n.length){e.innerHTML='<p style="text-align: center; color: #666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</p>';return}n.sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)),console.log("\uD83C\uDFA8 [UpdateList] Generating booking cards..."),e.innerHTML=n.map(e=>generateBookingCard(e)).join(""),console.log("\uD83C\uDFAF [UpdateList] Initializing card events..."),initializeBookingCardEvents(),console.log("‚úÖ [UpdateList] Booking list updated successfully")}).catch(t=>{console.error("‚ùå [UpdateList] Error loading bookings:",t),e.innerHTML=`
        <div style="text-align: center; padding: 40px; color: #ef4444;">
          <p style="font-size: 1.1em; margin-bottom: 10px;">
            ‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
          </p>
          <p style="color: #6b7280; font-size: 0.9em;">
            ${t.message}
          </p>
          <button onclick="updateBookingList()" 
                  style="margin-top: 20px; background: #22c55e; color: white; 
                         padding: 10px 20px; border: none; border-radius: 8px; 
                         cursor: pointer;">
            üîÑ ‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà
          </button>
        </div>
      `})}function generateBookingCard(e){let t={id:e.id,field:SecurityUtils.escapeHtml(e.field||"‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏ô‡∏≤‡∏°"),date:e.date,time:SecurityUtils.escapeHtml(e.time||"-"),username:SecurityUtils.escapeHtml(e.username||""),phone:SecurityUtils.sanitizePhone(e.phone||""),totalPrice:parseInt(e.totalPrice)||0,depositAmount:parseInt(e.depositAmount)||0,remainingAmount:parseInt(e.remainingAmount)||0,bookingStatus:e.bookingStatus||"pending",depositStatus:e.depositStatus,remainingStatus:e.remainingStatus,createdAt:e.createdAt,depositPaidAt:e.depositPaidAt,remainingPaidAt:e.remainingPaidAt},n="#f59e0b",i="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö",o="#fef3c7";"approved"===t.bookingStatus?(n="#10b981",i="‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß ‚úÖ",o="#d1fae5"):"pending_payment"===t.bookingStatus||"pending"===t.bookingStatus?(n="#f59e0b",i="‡∏£‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ‚è≥",o="#fef3c7"):"confirmed"===t.bookingStatus?(n="#3b82f6",i="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÅ‡∏•‡πâ‡∏ß",o="#dbeafe"):"completed"===t.bookingStatus?(n="#10b981",i="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô",o="#d1fae5"):"cancelled"===t.bookingStatus&&(n="#6b7280",i="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß",o="#f3f4f6");let a="",l="approved"===t.bookingStatus;if(l)try{let r=t.date,s=new Date().toISOString().split("T")[0];if(console.log(`üîç [Extension] Booking: ${r} | Today: ${s} | Status: ${t.bookingStatus}`),r===s){let d=JSON.stringify(e).replace(/"/g,"&quot;");a=`
          <button class="extend-booking-btn" 
                  data-booking-id="${t.id}"
                  data-booking-data="${d}"
                  id="extend-btn-${t.id}">
            <span>üîÑ</span>
            <span>‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤ 1 ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á</span>
          </button>
          <div class="next-slot-info" id="next-slot-${t.id}">
            ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ...
          </div>
        `,console.log(`‚úÖ [Extension] Button will be created for booking ${t.id}`)}else console.log(`‚è≠Ô∏è [Extension] Skipped - not today (${r} !== ${s})`)}catch(c){console.error("‚ùå [Extension] Error:",c)}else console.log(`‚è≠Ô∏è [Extension] Skipped - status: "${t.bookingStatus}" (need "approved")`);let u="";return["pending","pending_payment","approved"].includes(t.bookingStatus)&&(u=`
      <button class="cancel-btn" 
              data-booking-id="${t.id}"
              style="background: #ef4444; color: white; padding: 8px 16px; 
                     border: none; border-radius: 6px; cursor: pointer; 
                     font-size: 14px; margin-top: 10px;">
        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á
      </button>
    `),`
    <div class="booking-card" style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 4px solid ${n};">
      
      <!-- Header -->
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3 style="margin: 0; color: #1f2937; font-size: 18px;">üìã ${t.field}</h3>
        <span style="background: ${o}; color: ${n}; padding: 6px 12px; border-radius: 20px; font-weight: 600; font-size: 14px;">
          ${i}
        </span>
      </div>

      <!-- Info Grid -->
      <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin-bottom: 15px;">
        <div>
          <p style="margin: 0; color: #6b7280; font-size: 13px;">üìÖ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô</p>
          <p style="margin: 5px 0 0 0; color: #1f2937; font-weight: 600;">${(e=>{if(!e)return"-";try{let t=new Date(e);if(isNaN(t.getTime()))return"-";return t.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric"})}catch(n){return"-"}})(t.date)}</p>
        </div>
        <div>
          <p style="margin: 0; color: #6b7280; font-size: 13px;">‚è∞ ‡πÄ‡∏ß‡∏•‡∏≤</p>
          <p style="margin: 5px 0 0 0; color: #1f2937; font-weight: 600;">${t.time}</p>
        </div>
        <div>
          <p style="margin: 0; color: #6b7280; font-size: 13px;">üí∞ ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°</p>
          <p style="margin: 5px 0 0 0; color: #1f2937; font-weight: 600;">${t.totalPrice.toLocaleString()} ‡∏ö‡∏≤‡∏ó</p>
        </div>
        <div>
          <p style="margin: 0; color: #6b7280; font-size: 13px;">üì± ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</p>
          <p style="margin: 5px 0 0 0; color: #1f2937; font-weight: 600;">${t.phone}</p>
        </div>
      </div>

      <!-- Payment Status -->
      <div style="background: #f9fafb; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
          <span style="color: #6b7280; font-size: 13px;">üíµ ‡∏Ñ‡πà‡∏≤‡∏°‡πà‡∏ß‡∏ô 30%</span>
          <span style="font-weight: 600; color: ${"approved"===t.depositStatus?"#10b981":"#f59e0b"}">
            ${t.depositAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó 
            ${"approved"===t.depositStatus?"‚úÖ":"‚è≥"}
          </span>
        </div>
        <div style="display: flex; justify-content: space-between;">
          <span style="color: #6b7280; font-size: 13px;">üí∏ ‡∏Ñ‡πà‡∏≤‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</span>
          <span style="font-weight: 600; color: ${"paid"===t.remainingStatus?"#10b981":"#6b7280"}">
            ${t.remainingAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó
            ${"paid"===t.remainingStatus?"‚úÖ":""}
          </span>
        </div>
      </div>

      <!-- Extension Button -->
      ${a}

      <!-- Cancel Button -->
      ${u}

      <!-- Booking Info -->
      <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #e5e7eb;">
        <p style="margin: 0; color: #9ca3af; font-size: 12px;">
          üìã ‡∏à‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${(e=>{if(!e)return"-";try{let t=new Date(e);if(isNaN(t.getTime()))return"-";return t.toLocaleString("th-TH",{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(n){return"-"}})(t.createdAt)}
        </p>
      </div>
    </div>
  `}function initializeBookingCardEvents(){console.log("\uD83C\uDFAF [Events] Initializing booking card events...");let e=document.querySelectorAll(".extend-booking-btn");console.log(`  üìä Found ${e.length} extension buttons`),e.forEach(e=>{let t=e.getAttribute("data-booking-id"),n=e.getAttribute("data-booking-data");if(n)try{let i=JSON.parse(n.replace(/&quot;/g,'"'));checkNextSlotForBooking(i),console.log(`  ‚úÖ Checked next slot for booking ${t}`)}catch(o){console.error(`  ‚ùå Error parsing booking data for ${t}:`,o)}e.addEventListener("click",function(){t&&requestBookingExtension(t)})});let t=document.querySelectorAll(".cancel-btn");console.log(`  üìä Found ${t.length} cancel buttons`),t.forEach(e=>{e.addEventListener("click",function(){let e=this.getAttribute("data-booking-id");e&&cancelBooking(e)})}),console.log("‚úÖ [Events] Booking card events initialized")}function cancelBooking(e){if(isCancelling){debugLog("‚è≥ Already cancelling a booking...");return}if(!confirm("‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏±‡∏ô‡∏ó‡∏µ"))return;isCancelling=!0,debugLog("\uD83D\uDDD1Ô∏è Starting to cancel booking:",e);let t=document.getElementById(`cancel-btn-${e}`),n=t?t.textContent:"‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å";t&&(t.textContent="‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å...",t.disabled=!0);let i=database.ref("bookings/"+e);i.once("value").then(t=>{let n=t.val();if(debugLog("\uD83D\uDCCB Booking data:",n),!n)throw Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á");let i=auth.currentUser;if(!i)throw Error("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤ Login ‡∏Å‡πà‡∏≠‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á");if(n.userId!==i.uid)throw Error("‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ");let o=`${n.field}_${n.date}_${n.time}`;return debugLog("\uD83D\uDD11 Lock key:",o),Promise.all([database.ref("bookings/"+e).remove(),database.ref("booking_locks/"+o).remove()])}).then(()=>{console.log("‚úÖ Booking cancelled successfully"),alert("‚úÖ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß\n\n‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ñ‡∏π‡∏Å‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß"),updateBookingList()}).catch(e=>{console.error("‚ùå Cancel booking error:",e),alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+e.message)}).finally(()=>{isCancelling=!1,t&&(t.textContent=n,t.disabled=!1)})}console.log("‚úÖ Security Utils loaded successfully"),document.addEventListener("keydown",e=>{let t=document.getElementById("gallerySection");t&&isInViewport(t)&&("ArrowLeft"===e.key?changeGalleryImage(-1):"ArrowRight"===e.key&&changeGalleryImage(1))}),console.log("‚úÖ Improved Auth Handlers loaded successfully"),window.addEventListener("beforeunload",()=>{cleanupBookingLock()}),document.addEventListener("DOMContentLoaded",()=>{console.log("\uD83C\uDFAF DOM ready - initializing..."),initNavigation(),startSlider();let e=document.getElementById("loginModal");e&&e.addEventListener("click",e=>{"loginModal"===e.target.id&&closeLoginModal()}),document.addEventListener("keydown",e=>{if("Escape"===e.key){closeLoginModal();let t=document.getElementById("menuOverlay");t&&t.classList.contains("active")&&closeMobileMenu();let n=document.getElementById("extensionModal");n&&n.classList.contains("show")&&closeExtensionModal()}});let t=debounce(()=>{if(window.innerWidth>768){let e=document.getElementById("menuOverlay"),t=document.getElementById("hamburgerBtn");e&&e.classList.remove("active"),t&&t.classList.remove("active"),document.body.style.overflow=""}},150);window.addEventListener("resize",t)});const ToastSystem={container:null,init(){this.container||(this.container=document.getElementById("toast-container"),this.container||(this.container=document.createElement("div"),this.container.id="toast-container",document.body.appendChild(this.container)))},show(e,t="success",n=3e3){this.init();let i=document.createElement("div");return i.className=`toast toast-${t}`,i.innerHTML=`
      <span class="toast-icon">${({success:"‚úÖ",error:"‚ùå",warning:"‚ö†Ô∏è",info:"‚ÑπÔ∏è"})[t]}</span>
      <span class="toast-message">${e}</span>
      <button class="toast-close" onclick="this.parentElement.remove()">\xd7</button>
    `,this.container.appendChild(i),setTimeout(()=>i.classList.add("show"),10),setTimeout(()=>{i.classList.remove("show"),setTimeout(()=>i.remove(),300)},n),i},success(e,t){return this.show(e,"success",t)},error(e,t){return this.show(e,"error",t)},warning(e,t){return this.show(e,"warning",t)},info(e,t){return this.show(e,"info",t)}};function showToast(e,t="success",n=3e3){return ToastSystem.show(e,t,n)}const LoadingSystem={overlay:null,loadingText:null,init(){this.overlay||(this.overlay=document.getElementById("global-loading"),this.overlay||(this.overlay=document.createElement("div"),this.overlay.id="global-loading",this.overlay.innerHTML=`
          <div class="loading-overlay">
            <div class="spinner"></div>
            <p class="loading-text">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>
          </div>
        `,document.body.appendChild(this.overlay)),this.loadingText=this.overlay.querySelector(".loading-text"))},show(e="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î..."){this.init(),this.loadingText&&(this.loadingText.textContent=e),this.overlay.classList.add("active"),document.body.style.overflow="hidden"},hide(){this.overlay&&(this.overlay.classList.remove("active"),document.body.style.overflow="")},showButton(e,t){e.dataset.originalText=t||e.textContent,e.textContent="",e.classList.add("btn-loading"),e.disabled=!0},hideButton(e){e.textContent=e.dataset.originalText||"‡∏ï‡∏Å‡∏•‡∏á",e.classList.remove("btn-loading"),e.disabled=!1}};function showLoading(e){LoadingSystem.show(e)}function hideLoading(){LoadingSystem.hide()}let firebaseInitRetryCount=0;const MAX_FIREBASE_RETRIES=50;function initializeFirebase(){if(firebaseInitRetryCount++,window.firebaseLoadError){console.error("‚ùå Firebase scripts failed to load (network error)"),alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î Firebase scripts ‡πÑ‡∏î‡πâ\n\n‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:\n- Network ‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏ñ‡∏µ‡∏¢‡∏£\n- Firewall ‡∏ö‡∏•‡πá‡∏≠‡∏Å www.gstatic.com\n- ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î Console (F12) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î");return}if("undefined"==typeof firebase){if(firebaseInitRetryCount>50){console.error("‚ùå Firebase scripts failed to load after 5 seconds"),alert("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase ‡πÑ‡∏î‡πâ\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö:\n- ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï\n- Firewall/Proxy settings\n- Browser console (F12) ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î");return}(1===firebaseInitRetryCount||firebaseInitRetryCount%10==0)&&console.log("‚è≥ Waiting for Firebase scripts... ("+firebaseInitRetryCount+"/50)"),setTimeout(initializeFirebase,100);return}try{firebase.initializeApp({apiKey:"AIzaSyB6jVc8qcyS9zIJvfi-E1BL7BaxrUorO7w",authDomain:"prijit-sport.firebaseapp.com",databaseURL:"https://prijit-sport-default-rtdb.asia-southeast1.firebasedatabase.app",projectId:"prijit-sport",storageBucket:"prijit-sport.firebasestorage.app",messagingSenderId:"19782245186",appId:"1:19782245186:web:8ff3e2e17a214edc3546db"}),auth=firebase.auth(),database=firebase.database(),console.log("‚úÖ Firebase ready! (loaded in "+100*firebaseInitRetryCount+"ms)"),initializeTimeSlots(),console.log("‚úÖ Time slots initialized"),auth.onAuthStateChanged(e=>{e?database.ref("users/"+e.uid).once("value").then(t=>{currentUser={uid:e.uid,...t.val()},document.getElementById("currentUser").textContent=currentUser.fullname,document.getElementById("loginNavBtn").style.display="none",document.getElementById("userInfo").style.display="flex",updateBookingList(),console.log("‚úÖ Session restored:",currentUser.fullname)}).catch(e=>{console.error("‚ùå Failed to load user:",e)}):(currentUser=null,document.getElementById("loginNavBtn").style.display="inline-block",document.getElementById("userInfo").style.display="none")});let e=document.getElementById("dateSelect");if(e){let t=new Date().toISOString().split("T")[0];e.setAttribute("min",t)}document.addEventListener("keydown",function(e){if("Escape"===e.key){let t=document.getElementById("staffGalleryModal");t&&t.classList.contains("show")&&closeStaffModal()}});let n=document.querySelector(".staff-gallery-modal img");n&&n.addEventListener("click",function(e){e.stopPropagation()});let i=document.querySelector(".staff-gallery-close");i&&i.addEventListener("click",function(e){e.stopPropagation(),closeStaffModal()}),window.addEventListener("load",function(){let e=document.getElementById("staffGalleryModal"),t=document.getElementById("staffGalleryModalImg");if(e&&t){let n=0,i=0;e.addEventListener("touchstart",function(e){n=e.changedTouches[0].screenY},{passive:!0}),e.addEventListener("touchend",function(e){i=e.changedTouches[0].screenY;let t=i-n;t>100&&closeStaffModal()},{passive:!0}),console.log("‚úÖ Mobile touch events initialized")}}),console.log("‚úÖ XSS Protection Patches loaded successfully"),function e(){let t=document.getElementById("staffGalleryContainer");t&&database.ref("gallery").orderByChild("order").on("value",e=>{if(t.innerHTML="",!e.exists()){t.innerHTML='<div class="content-loading-state">\uD83D\uDCF7 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û</div>';return}let n=[];e.forEach(e=>{n.push({id:e.key,...e.val()})}),n.sort((e,t)=>(e.order||0)-(t.order||0)),n.forEach(e=>{let n=SecurityUtils.escapeHtml(e.title||"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠"),i=(e.url||"").replace(/[<>\"'`]/g,""),o=document.createElement("div");o.className="staff-gallery-card",o.setAttribute("data-image-url",i),o.addEventListener("click",function(){let e=this.getAttribute("data-image-url");e&&openStaffModal(e)}),o.innerHTML=`
        <img src="${i}" alt="${n}" loading="lazy" 
             onerror="this.src='placeholder.jpg'">
        <div class="staff-gallery-card-title">${n}</div>
      `,t.appendChild(o)})})}(),console.log("‚úÖ Staff Gallery loaded"),function e(){let t=document.getElementById("activitiesContainer");t&&database.ref("activities").orderByChild("createdAt").on("value",e=>{if(t.innerHTML="",!e.exists()){t.innerHTML='<div class="content-loading-state">\uD83D\uDCDD ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£</div>';return}let n=[];e.forEach(e=>{n.push({id:e.key,...e.val()})}),n.reverse(),n.forEach(e=>{let n=SecurityUtils.escapeHtml(e.title||"‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠"),i=SecurityUtils.escapeHtml(e.content||""),o=document.createElement("div");o.className="activity-card",o.innerHTML=`
        <div class="activity-header">
          <div class="activity-title">${n}</div>
          <div class="activity-date">${function e(t){if(!t)return"-";try{let n=new Date(t);if(isNaN(n.getTime()))return"-";return n.toLocaleDateString("th-TH",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"})}catch(i){return"-"}}(e.createdAt)}</div>
        </div>
        <div class="activity-content">${i}</div>
      `,t.appendChild(o)})})}(),console.log("‚úÖ Activities loaded")}catch(o){console.error("‚ùå Firebase initialization error:",o),alert("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Firebase:\n"+o.message)}}initializeFirebase(),"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.getRegistrations().then(e=>{e.length>0&&(console.log("\uD83D\uDD27 Firebase Service Worker detected"),e.forEach(e=>{e.navigationPreload&&e.navigationPreload.disable().then(()=>console.log("‚úÖ Navigation preload disabled")).catch(()=>{})}))}).catch(()=>{})}),window.addEventListener("unhandledrejection",e=>{e.reason&&e.reason.message&&e.reason.message.includes("service worker")&&(console.log("‚ö†Ô∏è Service Worker error caught and ignored"),e.preventDefault())});let currentExtensionBooking=null,extensionCountdownInterval=null;async function checkNextSlotForBooking(e){let t=e.time.split(" - ");if(t.length<2)return;let n=t[1],i=n,o=addOneHourToTime(n);if(null===o){let a=document.getElementById(`next-slot-${e.id}`),l=document.getElementById(`extend-btn-${e.id}`);a&&(a.innerHTML=`
        <span style="color: #f59e0b;">‚è∞ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ (‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ 07:00-20:00)</span>
      `),l&&(l.style.display="none");return}try{let r=await database.ref("bookings").orderByChild("field_date_time").equalTo(`${e.field}_${e.date}_${i} - ${o}`).once("value"),s=document.getElementById(`next-slot-${e.id}`);if(!s)return;if(r.exists()){s.innerHTML=`
        <span style="color: #ef4444;">‚ùå ‡∏ä‡πà‡∏ß‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ${i} - ${o} ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß</span>
      `;let d=document.getElementById(`extend-btn-${e.id}`);d&&(d.disabled=!0)}else s.innerHTML=`
        <span style="color: #22c55e;">‚úì ‡∏ä‡πà‡∏ß‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ${i} - ${o} ‡∏ß‡πà‡∏≤‡∏á</span>
      `}catch(c){console.error("Error checking next slot:",c)}}async function requestBookingExtension(e){try{let t=await database.ref(`bookings/${e}`).once("value"),n=t.val();if(!n){showToast("‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á","error");return}currentExtensionBooking={...n,id:e};let i=n.time.split(" - "),o=i[1],a=o,l=addOneHourToTime(o);if(null===l){showToast("‚è∞ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏° (07:00-20:00)","error");return}let r=await database.ref("bookings").orderByChild("field_date_time").equalTo(`${n.field}_${n.date}_${a} - ${l}`).once("value"),s=document.getElementById("extensionModal");if(s.classList.add("show"),r.exists())document.getElementById("availableExtensionSlot").style.display="none",document.getElementById("bookedExtensionSlot").style.display="block",document.getElementById("bookedExtensionSlotTime").textContent=`${a} - ${l}`,await findAlternativeSlots(n);else{document.getElementById("availableExtensionSlot").style.display="block",document.getElementById("bookedExtensionSlot").style.display="none",document.getElementById("extensionSlotTime").textContent=`${a} - ${l}`;let d=parseInt(a.split(":")[0]),c=calculateFieldPrice(n.field,d);document.getElementById("extensionSlotPrice").textContent=c,startExtensionCountdown(300)}}catch(u){console.error("Error requesting extension:",u),showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+u.message,"error")}}function startExtensionCountdown(e){let t=e,n=document.getElementById("extensionCountdown"),i=document.getElementById("confirmExtensionBtn");extensionCountdownInterval&&clearInterval(extensionCountdownInterval),extensionCountdownInterval=setInterval(()=>{t--;let e=Math.floor(t/60),o=t%60;n.textContent=`${e}:${o.toString().padStart(2,"0")}`,t<=60&&(n.style.color="#dc2626"),t<=0&&(clearInterval(extensionCountdownInterval),i.disabled=!0,showToast("‚è∞ ‡∏´‡∏°‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á","error"),setTimeout(()=>closeExtensionModal(),2e3))},1e3)}async function confirmExtensionPayment(){if(!currentExtensionBooking)return;let e=document.getElementById("confirmExtensionBtn");e.textContent="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£...",e.disabled=!0;try{let t=currentExtensionBooking,n=t.time.split(" - "),i=n[1],o=i,a=addOneHourToTime(i);if(null===a){showToast("‚è∞ ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏î‡πâ ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏≤‡∏° (07:00-20:00)","error"),e.textContent="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",e.disabled=!1;return}let l=`${o} - ${a}`,r=parseInt(o.split(":")[0]),s=calculateFieldPrice(t.field,r),d=database.ref("bookings").push(),c=`${t.field}_${t.date}_${l}`,u={userId:t.userId,username:t.username,phone:t.phone,field:t.field,date:t.date,time:l,totalPrice:s,depositAmount:0,remainingAmount:s,depositStatus:"not_required",remainingStatus:"unpaid",bookingStatus:"approved",extendedFrom:t.id,field_date_time:c,createdAt:new Date().toISOString()};await d.set(u),await database.ref(`bookings/${t.id}`).update({extendedTo:d.key}),showToast("‚úÖ ‡∏ï‡πà‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£","success"),closeExtensionModal(),updateBookingList()}catch(g){console.error("Error confirming extension:",g),showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+g.message,"error"),e.textContent="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",e.disabled=!1}}async function findAlternativeSlots(e){console.log("\uD83D\uDD0D Finding alternative slots for:",e.time);let t=document.getElementById("alternativeSlotsList");t.innerHTML='<div class="alternative-title">\uD83D\uDCA1 ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</div>';try{let n=e.time.split(" - "),i=n[1];console.log("  Current end time:",i);let o=["08:00","09:00","10:00","11:00","12:00","13:00","14:00","15:00","16:00","17:00","18:00","19:00","20:00"],a=o.indexOf(i);console.log("  Current index:",a);let l=a;if(-1===a){let r=parseInt(i.split(":")[0]);l=o.findIndex(e=>parseInt(e.split(":")[0])===r),console.log("  Using hour-based index:",l)}let s=[];for(let d=l+1;d<o.length&&s.length<5;d++){let c=o[d],u=addOneHourToTime(c);if(null===u)continue;let g=`${c} - ${u}`,p=await database.ref("bookings").orderByChild("field_date_time").equalTo(`${e.field}_${e.date}_${g}`).once("value");if(!p.exists()){let m=parseInt(c.split(":")[0]),f=calculateFieldPrice(e.field,m),y=document.createElement("div");y.className="alternative-slot",y.innerHTML=`
          <span class="alternative-slot-time">${g}</span>
          <span class="alternative-slot-price">${f} ‡∏ö‡∏≤‡∏ó</span>
        `,y.onclick=()=>selectAlternativeSlot(g,f),t.appendChild(y),s.push(g)}}0===s.length&&(t.innerHTML+='<p style="text-align: center; color: #6b7280; padding: 20px;">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á</p>')}catch($){console.error("Error finding alternatives:",$)}}function selectAlternativeSlot(e,t){confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á ${e} ‡πÉ‡∏ô‡∏£‡∏≤‡∏Ñ‡∏≤ ${t} ‡∏ö‡∏≤‡∏ó‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`)&&createAlternativeBooking(e,t)}async function createAlternativeBooking(e,t){try{if(!currentExtensionBooking){showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á","error");return}let n=currentExtensionBooking,i=`${n.field}_${n.date}_${e}`;showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ß‡πà‡∏≤‡∏á...");let o=await database.ref("bookings").orderByChild("field_date_time").equalTo(i).once("value");if(o.exists()){hideLoading(),showToast("‚ùå ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏à‡∏≠‡∏á‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏∑‡πà‡∏ô","error");return}showLoading("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á...");let a=database.ref("booking_locks/"+i);await a.set({userId:n.userId,timestamp:Date.now()});let l=database.ref("bookings").push(),r={userId:n.userId,username:n.username,phone:n.phone,field:n.field,date:n.date,time:e,totalPrice:t,depositAmount:0,remainingAmount:t,depositStatus:"not_required",remainingStatus:"unpaid",bookingStatus:"approved",field_date_time:i,createdAt:new Date().toISOString(),alternativeBooking:!0};await l.set(r),await a.remove(),hideLoading(),showToast("‚úÖ ‡∏à‡∏≠‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô","success"),closeExtensionModal(),updateBookingList(),setTimeout(()=>{let e=document.getElementById("checkBookingSection");e&&e.scrollIntoView({behavior:"smooth",block:"start"})},500)}catch(s){console.error("Error creating alternative booking:",s),hideLoading(),showToast("‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: "+s.message,"error")}}function closeExtensionModal(){let e=document.getElementById("extensionModal");e.classList.remove("show"),extensionCountdownInterval&&clearInterval(extensionCountdownInterval);let t=document.getElementById("confirmExtensionBtn");t.textContent="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô",t.disabled=!1,currentExtensionBooking=null}function addOneHourToTime(e){let[t,n]=e.split(":").map(Number),i=t+1;return i>20?null:`${i.toString().padStart(2,"0")}:${n.toString().padStart(2,"0")}`}function calculateFieldPrice(e,t){let n=0;return e.includes("‡∏™‡∏ô‡∏≤‡∏° 1")||e.includes("‡∏™‡∏ô‡∏≤‡∏° 2")||e.includes("‡∏™‡∏ô‡∏≤‡∏° 3")?n=t>=18?1200:1e3:e.includes("‡∏™‡∏ô‡∏≤‡∏° 4")?n=t>=18?1300:1100:e.includes("‡∏™‡∏ô‡∏≤‡∏° 5")?n=t>=18?1100:900:e.includes("‡∏™‡∏ô‡∏≤‡∏° 6")&&(n=t>=18?900:700),n}window.addEventListener("beforeunload",()=>{if(console.log("\uD83E\uDDF9 Cleaning up resources..."),database&&(database.ref("bookings").off(),database.ref("users").off()),void 0!==paymentTimer&&paymentTimer&&clearInterval(paymentTimer),void 0!==extensionCountdownInterval&&extensionCountdownInterval&&clearInterval(extensionCountdownInterval),void 0!==currentBookingData&&currentBookingData){let e=`${currentBookingData.field}_${currentBookingData.date}_${currentBookingData.time}`;database.ref("booking_locks/"+e).remove().catch(()=>{})}}),initializeFirebase();